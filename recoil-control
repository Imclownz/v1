// advanced-recoil-control.js
class RecoilMasterSystem {
    constructor() {
        this.weaponDatabase = this.getWeaponDatabase();
        this.sessionToken = "RC_" + Date.now().toString(36);
        this.stabilityLevel = 1.0;
        this.lastUpdate = Date.now();
        this.performanceMode = "balanced";
    }

    process(body) {
        try {
            let data = JSON.parse(body);
            const weaponType = data.weaponType || 'default';
            const profile = this.weaponDatabase[weaponType] || this.weaponDatabase.default;
            
            // Cập nhật chế độ hiệu năng
            if (data.performanceState) {
                this.updatePerformanceMode(data.performanceState);
            }
            
            this.updateStability(data.gameState);
            
            data.recoilSystem = {
                version: "7.0",
                mode: "adaptive_ai",
                horizontalCompensation: this.applyPerformanceFactor(profile.horizontal),
                verticalCompensation: this.applyPerformanceFactor(profile.vertical),
                patternElimination: "neural_network",
                smoothingFactor: profile.smoothing,
                realtimeAdjustment: true,
                security: {
                    token: this.sessionToken,
                    checksum: this.generateChecksum(),
                    behavior: this.getRecoilBehavior()
                },
                performanceMode: this.performanceMode
            };
            
            if (data.gameState?.isFiring) {
                data.recoilSystem.fireStability = this.applyPerformanceFactor(profile.fireStability);
            }
            
            // Tích hợp với hệ thống aim
            if (data.aimSystem?.lockStrength > 0.95) {
                data.recoilSystem.stabilityBoost = 2.5;
                data.recoilSystem.verticalCompensation *= 1.8;
            }
            
            return JSON.stringify(data);
        } catch (e) {
            console.error("[RECOIL MASTER] Error:", e.message.substring(0, 20));
            return body;
        }
    }

    applyPerformanceFactor(value) {
        switch (this.performanceMode) {
            case "high": return value * 1.2;
            case "balanced": return value;
            case "low": return value * 0.8;
            default: return value;
        }
    }

    updatePerformanceMode(performanceState) {
        if (!performanceState) return;
        
        if (performanceState.cpuUsage > 0.8 || performanceState.memoryUsage > 80) {
            this.performanceMode = "low";
        } else if (performanceState.cpuUsage > 0.6 || performanceState.memoryUsage > 70) {
            this.performanceMode = "balanced";
        } else {
            this.performanceMode = "high";
        }
    }

    updateStability(gameState) {
        if (!gameState) return;
        
        if (Date.now() - this.lastUpdate < 200) return;
        this.lastUpdate = Date.now();
        
        let stability = 1.0;
        
        // Điều chỉnh dựa trên tư thế
        if (gameState.stance === 'crouching') stability *= 1.4;
        else if (gameState.stance === 'prone') stability *= 1.8;
        
        // Điều chỉnh dựa trên chuyển động
        if (gameState.isMoving) stability *= 0.8;
        if (gameState.isSprinting) stability *= 0.5;
        
        // Điều chỉnh dựa trên máu
        if (gameState.playerHealth < 30) stability *= 0.85;
        
        // Giới hạn giá trị
        this.stabilityLevel = Math.max(0.2, Math.min(2.0, stability));
    }

    getWeaponDatabase() {
        return {
            default: {
                horizontal: 0.05,
                vertical: 0.08,
                smoothing: 0.88,
                fireStability: 0.92
            },
            sniper: {
                horizontal: 0.01,
                vertical: 0.15,
                smoothing: 0.95,
                fireStability: 0.98
            },
            ar: {
                horizontal: 0.06,
                vertical: 0.09,
                smoothing: 0.85,
                fireStability: 0.9
            },
            smg: {
                horizontal: 0.07,
                vertical: 0.06,
                smoothing: 0.8,
                fireStability: 0.85
            },
            shotgun: {
                horizontal: 0.1,
                vertical: 0.12,
                smoothing: 0.75,
                fireStability: 0.8
            }
        };
    }

    generateChecksum() {
        const crypto = require('crypto');
        const data = this.sessionToken + this.stabilityLevel;
        return crypto.createHash('sha256').update(data).digest('hex');
    }

    getRecoilBehavior() {
        const behaviors = ["steady", "smooth", "controlled", "natural"];
        return behaviors[Math.floor(Math.random() * behaviors.length)];
    }
}

const recoilSystem = new RecoilMasterSystem();
$done({ body: recoilSystem.process($response.body) });
