// ADVANCED PERFORMANCE OPTIMIZER v5.0
class AdvancedPerformanceOptimizer {
    constructor() {
        this.modules = {
            aim: { cpu: 0.40, enabled: true },
            recoil: { cpu: 0.30, enabled: true },
            graphics: { cpu: 0.15, enabled: true }
        };
        this.graphicsPresets = {
            ultra: { texture: "ultra", shadow: "high", effects: "high", resScale: 1.0 },
            high: { texture: "high", shadow: "medium", effects: "medium", resScale: 0.95 },
            balanced: { texture: "medium", shadow: "low", effects: "medium", resScale: 0.9 },
            low: { texture: "low", shadow: "off", effects: "low", resScale: 0.8 },
            minimal: { texture: "minimal", shadow: "off", effects: "off", resScale: 0.7 }
        };
        this.currentPreset = "balanced";
        this.lastAdjustment = 0;
    }

    process(body) {
        try {
            const data = JSON.parse(body);
            
            if (data.performanceState) {
                this.adjustSystem(data.performanceState);
            }
            
            if (data.graphicsSettings) {
                data.graphicsSettings = this.applyGraphicsPreset(data.graphicsSettings);
            }
            
            data.performance = {
                preset: this.currentPreset,
                moduleAllocations: this.modules
            };

            return JSON.stringify(data);
        } catch (e) {
            console.error("[PERF OPTIMIZER] Error:", e.message);
            return body;
        }
    }

    adjustSystem(perfState) {
        if (Date.now() - this.lastAdjustment < 5000) return;
        this.lastAdjustment = Date.now();
        
        // Ưu tiên hệ thống aim khi chiến đấu
        if (perfState.inCombat) {
            this.modules.aim.cpu = Math.min(0.45, this.modules.aim.cpu + 0.05);
            this.modules.graphics.cpu = Math.max(0.10, this.modules.graphics.cpu - 0.05);
        }
        
        // Giảm đồ họa khi nhiệt độ cao
        if (perfState.temperature > 45) {
            this.downgradeGraphics();
        }
        
        // Chế độ sinh tồn khi máu thấp
        if (perfState.playerHealth < 30) {
            this.activateSurvivalMode();
        }
    }

    downgradeGraphics() {
        const presets = ["ultra", "high", "balanced", "low", "minimal"];
        const currentIndex = presets.indexOf(this.currentPreset);
        if (currentIndex < presets.length - 1) {
            this.currentPreset = presets[currentIndex + 1];
        }
    }

    activateSurvivalMode() {
        this.modules.aim.cpu = 0.45;
        this.currentPreset = "minimal";
    }

    applyGraphicsPreset(settings) {
        const preset = this.graphicsPresets[this.currentPreset];
        return {
            ...settings,
            textureQuality: preset.texture,
            shadowQuality: preset.shadow,
            effectQuality: preset.effects,
            resolutionScale: preset.resScale
        };
    }
}

const perfOptimizer = new AdvancedPerformanceOptimizer();
$done({ body: perfOptimizer.process($response.body) });
